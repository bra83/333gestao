<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>3D Print ERP</title>
    <meta name="theme-color" content="#059669" />
    <meta name="description" content="Dashboard de controle para impressão 3D" />
    <link rel="manifest" href="./manifest.json" />
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;900&display=swap" rel="stylesheet">

    <!-- Tailwind CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              sans: ['Nunito', 'sans-serif'],
            },
            colors: {
              primary: '#059669',
              primaryDark: '#047857',
              secondary: '#64748b',
              dark: '#ecfdf5',
              surface: '#ffffff',
              accent: '#34d399',
            }
          }
        }
      }
    </script>
    
    <script>
      window.APPS_SCRIPT_URL = "/**
 * ERP 3D PRINT - SCRIPT FINAL (v6.0)
 * - Auto-Reparo de Colunas e IDs
 * - Extermínio de duplicatas
 * - Suporte a FormData
 */

function doGet(e) {
  if (e.parameter.type === 'read_data') {
    return createResponse({
      estoque: getSheetDataAndRepairIds(SpreadsheetApp.getActiveSpreadsheet(), 'Estoque', 'ST'),
      vendas: getSheetDataAndRepairIds(SpreadsheetApp.getActiveSpreadsheet(), 'Vendas', 'VE'),
      gastos: getSheetDataAndRepairIds(SpreadsheetApp.getActiveSpreadsheet(), 'Gastos', 'GA')
    });
  }
  if (e.parameter.type === 'read_settings') {
    return createResponse(getSettings(SpreadsheetApp.getActiveSpreadsheet()));
  }
  return createResponse({ status: "ready" });
}

function doPost(e) {
  try {
    let params = e.parameter;
    if (!params || !params.type) {
       if (e.postData && e.postData.contents) {
          try { params = JSON.parse(e.postData.contents); } catch(err){}
       }
    }
    
    // Fallback se params continuar vazio
    if (!params) params = {};

    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const type = params.type;
    const action = params.action;
    
    // COMANDO ESPECIAL: Manutenção de Estrutura
    if (type === 'maintenance') {
      performMaintenance(ss, 'Estoque', 'ST');
      performMaintenance(ss, 'Vendas', 'VE');
      performMaintenance(ss, 'Gastos', 'GA');
      return createResponse({ status: "maintenance_complete" });
    }
    
    if (type === 'save_settings') return createResponse(saveSettings(ss, params));

    let sheetName = '';
    if (type === 'estoque') sheetName = 'Estoque';
    if (type === 'venda') sheetName = 'Vendas';
    if (type === 'gasto') sheetName = 'Gastos';

    if (sheetName) {
      const sheet = ss.getSheetByName(sheetName);
      if (!sheet) throw new Error("Aba não encontrada");
      
      if (action === 'delete') {
        const id = params.id;
        if (!id) throw new Error("ID ausente");
        return createResponse(deleteRowAggressive(sheet, id));
      } else {
        return createResponse(upsertRow(sheet, params));
      }
    }
    return createResponse({ status: "ok" });
  } catch (err) {
    return createResponse({ status: "error", message: err.toString() });
  }
}

// --- FUNÇÕES ---

function createResponse(data) {
  return ContentService.createTextOutput(JSON.stringify(data)).setMimeType(ContentService.MimeType.JSON);
}

// Verifica se a primeira coluna é ID. Se não for, INSERE uma coluna ID.
function performMaintenance(ss, sheetName, prefix) {
  let sheet = ss.getSheetByName(sheetName);
  if (!sheet) return;
  
  const headers = sheet.getRange(1, 1, 1, sheet.getLastColumn() || 1).getValues()[0];
  if (!headers || headers.length === 0) return;
  
  // Se o primeiro cabeçalho NÃO for 'ID', precisamos consertar
  if (String(headers[0]).toUpperCase().trim() !== 'ID') {
    sheet.insertColumns(1); // Insere Coluna A
    sheet.getRange("A1").setValue("ID"); // Define Header
  }
  
  // Roda o reparo de IDs agora que a coluna existe (ou já existia)
  getSheetDataAndRepairIds(ss, sheetName, prefix);
}

function getSheetDataAndRepairIds(ss, name, prefix) {
  let sheet = ss.getSheetByName(name);
  if (!sheet) {
    sheet = ss.insertSheet(name);
    // Cria headers se novo
    if(name === 'Estoque') sheet.appendRow(['ID', 'Nome', 'Marca', 'Peso', 'Preco', 'Cor', 'Tipo']);
    if(name === 'Vendas') sheet.appendRow(['ID', 'Data', 'Item', 'Material', 'Peso', 'Venda', 'Lucro']);
    if(name === 'Gastos') sheet.appendRow(['ID', 'Descricao', 'Valor', 'Data']);
  }
  
  const range = sheet.getDataRange();
  const values = range.getValues();
  if (values.length < 2) return [];

  const headers = values[0];
  const now = new Date().getTime();
  
  // Garante que headers[0] seja ID
  if (String(headers[0]).toUpperCase().trim() !== 'ID') {
    // Se não for ID, estamos em apuros, retorna vazio ou tenta ler assim mesmo (mas vai dar erro no delete)
    // A função maintenance deve ser chamada para corrigir isso.
  }

  // Preenche IDs vazios
  for (let i = 1; i < values.length; i++) {
    const val = values[i][0];
    // Se vazio OU se parece ser um nome (ex: não começa com prefixo e tem espaço), forçamos ID
    // Mas cuidado para não sobrescrever IDs legados. Vamos assumir que se não tem ID, cria.
    if (!val || String(val).trim() === "") {
      const newId = prefix + (now + i);
      values[i][0] = newId;
      sheet.getRange(i + 1, 1).setValue(newId);
    }
  }
  
  return values.slice(1).map(row => {
    let obj = {};
    headers.forEach((h, i) => obj[h.toLowerCase()] = row[i]);
    return obj;
  });
}

function deleteRowAggressive(sheet, id) {
  const data = sheet.getDataRange().getValues();
  let deletedCount = 0;
  const targetId = String(id).trim();

  for (let i = data.length - 1; i >= 1; i--) {
    const rowId = String(data[i][0]).trim();
    if (rowId === targetId) {
      sheet.deleteRow(i + 1);
      deletedCount++;
    }
  }
  return { status: deletedCount > 0 ? "deleted" : "not_found", count: deletedCount };
}

function upsertRow(sheet, params) {
  const data = sheet.getDataRange().getValues();
  const headers = data[0];
  const id = String(params.id).trim();
  
  const newRow = headers.map(h => {
    const key = h.toLowerCase();
    let val = params[key];
    if (val === undefined || val === null) val = "";
    if (["peso", "preco", "venda", "lucro", "valor", "kwh", "markup"].includes(key)) {
      val = String(val).replace(',', '.');
      val = parseFloat(val) || 0;
    }
    return val;
  });

  for (let i = 1; i < data.length; i++) {
    if (String(data[i][0]).trim() === id) {
      sheet.getRange(i + 1, 1, 1, newRow.length).setValues([newRow]);
      return { status: "updated", id: id };
    }
  }
  sheet.appendRow(newRow);
  return { status: "created", id: id };
}

function getSettings(ss) {
  const sheet = ss.getSheetByName('Config');
  if (!sheet) return {};
  const values = sheet.getDataRange().getValues();
  let settings = {};
  values.forEach(row => { if (row[0]) settings[row[0]] = row[1]; });
  return settings;
}

function saveSettings(ss, params) {
  let sheet = ss.getSheetByName('Config');
  if (!sheet) sheet = ss.insertSheet('Config');
  sheet.clear();
  const entries = Object.entries(params)
    .filter(([k]) => !['type', 'action', 'id'].includes(k))
    .map(([k, v]) => [k, v]);
  if (entries.length > 0) sheet.getRange(1, 1, entries.length, 2).setValues(entries);
  return { status: "settings_saved" };
}";
    </script>

    <style>
      body {
        background-color: #ecfdf5;
        color: #334155;
        margin: 0;
      }
      #loading-spinner {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        height: 100vh;
        color: #059669;
      }
      .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #d1fae5;
        border-top-color: #059669;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }
      @keyframes spin { to { transform: rotate(360deg); } }
    </style>
  <script type="importmap">
{
  "imports": {
    "react/": "https://esm.sh/react@^19.2.3/",
    "react": "https://esm.sh/react@^19.2.3",
    "@vitejs/plugin-react": "https://esm.sh/@vitejs/plugin-react@^5.1.2",
    "recharts": "https://esm.sh/recharts@^3.6.0",
    "react-dom/": "https://esm.sh/react-dom@^19.2.3/",
    "vite": "https://esm.sh/vite@^7.3.1"
  }
}
</script>
</head>
  <body>
    <div id="root">
      <div id="loading-spinner">
        <div class="spinner"></div>
        <p style="margin-top: 15px; font-weight: 700; font-family: sans-serif;">Carregando ERP 3D...</p>
      </div>
    </div>
    
    <script type="module" src="./index.tsx"></script>
    
    <script>
      if ('serviceWorker' in navigator && window.location.hostname !== 'localhost') {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('./sw.js').then(reg => {
            console.log('SW registrado: ', reg.scope);
          }, err => {
            console.log('SW falhou: ', err);
          });
        });
      }
    </script>
  </body>
</html>
